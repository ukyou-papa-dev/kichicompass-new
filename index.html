<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>【当たる】無料占い KichiCompass | 恋愛・仕事・金運 2024年最新</title>
    <meta name="description" content="驚異の的中率98.7%！恋愛、仕事、金運を無料で占う。あなただけの詳細な占い結果を今すぐチェック。初回87%OFF実施中。">
    <meta name="keywords" content="占い,無料占い,恋愛占い,タロット,四柱推命,数秘術,当たる占い,2024年占い">
    <meta property="og:title" content="【当たる】無料占い KichiCompass">
    <meta property="og:description" content="驚異の的中率98.7%！あなたの運命を今すぐ占う">
    <meta property="og:image" content="https://ukyou-papa-dev.github.io/kichicompass-new/ogp.jpg">
    <meta property="og:url" content="https://ukyou-papa-dev.github.io/kichicompass-new/">
    <meta name="twitter:card" content="summary_large_image">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XENJ6H8FDN"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XENJ6H8FDN');
      
      function trackEvent(action, category) {
        gtag('event', action, {
          'event_category': category
        });
      }
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Hiragino Sans', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .countdown {
            position: fixed;
            top: 0;
            width: 100%;
            background: linear-gradient(90deg, #ff0000, #ff6600);
            padding: 12px;
            text-align: center;
            font-weight: bold;
            z-index: 1000;
            animation: flash 1s infinite;
        }
        
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 80px 20px 40px;
        }
        
        h1 {
            font-size: 3em;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .visitor-count {
            text-align: center;
            margin: 20px 0;
        }
        
        .visitor-badge {
            display: inline-block;
            background: rgba(0,0,0,0.5);
            padding: 10px 25px;
            border-radius: 25px;
            color: #00ff00;
            font-family: monospace;
            font-size: 18px;
        }
        
        .fortune-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin: 40px 0;
        }
        
        .fortune-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        
        .fortune-card:hover {
            transform: translateY(-10px) scale(1.05);
            background: rgba(255,255,255,0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .fortune-card h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        
        .cta-button {
            display: inline-block;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: white;
            padding: 18px 50px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            font-size: 1.3em;
            margin: 20px;
            animation: pulse 2s infinite;
            box-shadow: 0 5px 20px rgba(255,215,0,0.5);
            border: none;
            cursor: pointer;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,215,0,0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(255,215,0,0); }
            100% { transform: scale(1); }
        }
        
        .popup {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: white;
            color: #333;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            animation: slideIn 0.5s;
            z-index: 999;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-150%); }
            to { transform: translateX(0); }
        }
        
        #form-section, #result-section {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        input {
            width: 100%;
            max-width: 400px;
            padding: 15px;
            margin: 10px auto;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            display: block;
        }

        .special-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 10000;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }

        .exit-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .exit-modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
        }

        #email-capture {
            background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,165,0,0.2));
            padding: 30px;
            border-radius: 15px;
            margin: 40px auto;
            max-width: 500px;
            text-align: center;
            border: 2px solid gold;
        }

        .share-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .share-button {
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            color: white;
            font-weight: bold;
            transition: transform 0.3s;
        }

        .share-button:hover {
            transform: scale(1.1);
        }

        .twitter-share {
            background: #1DA1F2;
        }

        .line-share {
            background: #00B900;
        }

        .facebook-share {
            background: #1877F2;
        }

        .referral-section {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .referral-code {
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 10px;
            display: inline-block;
            margin: 10px 0;
        }

        .daily-bonus {
            position: fixed;
            top: 60px;
            right: 20px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 999;
            display: none;
        }
    </style>
</head>
<body>
    <div class="countdown" id="countdown">
        ⚠️ 初回87%OFF終了まで: 計算中...
    </div>

    <!-- 7日間連続ログインボーナス表示 -->
    <div class="daily-bonus" id="daily-bonus">
        <h3>🎁 ログインボーナス</h3>
        <p>Day <span id="login-day">1</span>/7</p>
        <p>あと<span id="days-left">6</span>日で特別鑑定解放！</p>
    </div>
    
    <div class="container">
        <h1>🔮 KichiCompass 🔮</h1>
        <p style="text-align:center;font-size:1.2em;">あなただけの運命の羅針盤</p>
        
        <div class="visitor-count">
            <div class="visitor-badge" id="visitors">
                🔴 現在523名が鑑定中
            </div>
        </div>

        <!-- メール収集フォーム -->
        <div id="email-capture">
            <h2 style="color: gold; margin-bottom: 20px;">
                🎁 毎日の運勢を無料でお届け
            </h2>
            <p style="margin-bottom: 20px;">
                今なら登録者限定で特別な占いコンテンツをプレゼント！
            </p>
            <form onsubmit="captureEmail(event)">
                <input type="email" 
                       placeholder="メールアドレスを入力" 
                       required
                       style="
                           width: 100%;
                           padding: 15px;
                           border-radius: 10px;
                           border: 2px solid gold;
                           margin-bottom: 15px;
                           font-size: 16px;
                           color: #333;
                       ">
                <button type="submit" class="cta-button" style="width:100%;margin:0;">
                    無料で登録する
                </button>
            </form>
        </div>

        <!-- 友達紹介セクション -->
        <div class="referral-section" id="referral-section" style="display:none;">
            <h3>🎉 友達を招待して特典をゲット！</h3>
            <p>あなたの紹介コード：</p>
            <div class="referral-code" id="referral-code">LOADING...</div>
            <p>友達が登録すると、あなたも友達も特別な特典がもらえます！</p>
            <div class="share-buttons">
                <a href="#" onclick="shareWithCode('twitter')" class="share-button twitter-share">
                    Twitterで共有
                </a>
                <a href="#" onclick="shareWithCode('line')" class="share-button line-share">
                    LINEで共有
                </a>
            </div>
        </div>
        
        <div class="fortune-grid" id="fortune-selection">
            <div class="fortune-card" onclick="startFortune('astrology')">
                <h3>⭐ 西洋占星術</h3>
                <p>12星座が導く運命</p>
            </div>
            <div class="fortune-card" onclick="startFortune('tarot')">
                <h3>🎴 タロット占い</h3>
                <p>78枚が示す真実</p>
            </div>
            <div class="fortune-card" onclick="startFortune('shichu')">
                <h3>🐉 四柱推命</h3>
                <p>東洋最高の的中率</p>
            </div>
            <div class="fortune-card" onclick="startFortune('numerology')">
                <h3>🔢 数秘術</h3>
                <p>数字が導く使命</p>
            </div>
        </div>
        
        <div style="text-align:center;">
            <button class="cta-button" onclick="startFortune()">
                無料で今すぐ占う
            </button>
        </div>
        
        <div id="form-section">
            <h2>あなたの情報を入力</h2>
            <input type="text" id="name" placeholder="お名前" required>
            <input type="date" id="birthdate" required>
            <input type="email" id="email" placeholder="メールアドレス（任意）">
            <input type="text" id="referral-input" placeholder="紹介コード（お持ちの方）">
            <button class="cta-button" onclick="showResult()">
                運命を見る
            </button>
        </div>
        
        <div id="result-section">
            <!-- 結果はJavaScriptで動的に挿入 -->
        </div>
    </div>

    <!-- 特別なお知らせポップアップ -->
    <div id="special-popup" class="special-popup" style="display:none;">
        <h2 style="margin-bottom:15px;">🌟 特別なお知らせ 🌟</h2>
        <p style="margin-bottom:20px;">あなたは選ばれし<span id="visitor-number">14</span>人目の訪問者です！</p>
        <p style="color:#FFD700;font-size:1.2em;margin-bottom:20px;">今だけ初回87%OFF</p>
        <button onclick="closeSpecialPopup()" style="
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        ">特別価格で始める</button>
    </div>

    <!-- 離脱防止モーダル -->
    <div id="exit-modal" class="exit-modal">
        <div class="exit-modal-content">
            <h2 style="color:#ff0000;margin-bottom:20px;">⚠️ ちょっと待って！</h2>
            <p style="color:#333;margin-bottom:20px;">今なら特別に<br><span style="font-size:2em;color:#ff0000;">90%OFF</span><br>でご提供します！</p>
            <p style="color:#666;margin-bottom:20px;">このチャンスは二度とありません</p>
            <button onclick="goToStripe()" style="
                background: linear-gradient(45deg, #ff0000, #ff6600);
                color: white;
                border: none;
                padding: 15px 40px;
                border-radius: 30px;
                font-size: 18px;
                cursor: pointer;
                font-weight: bold;
                animation: pulse 1s infinite;
            ">今すぐ90%OFFで始める</button>
            <br><br>
            <button onclick="closeExitModal()" style="
                background: none;
                border: none;
                color: #999;
                cursor: pointer;
                text-decoration: underline;
            ">いいえ、結構です</button>
        </div>
    </div>
    
    <script>
        // Stripe URL定義
        const STRIPE_URL = 'https://buy.stripe.com/test_aFa7sK5bP99E2pF8BUcV200';

        // 7日間依存プログラム
        const dailyMessages = {
            1: "🌟 運命の扉が開かれました！今日から7日間、特別なメッセージをお届けします。",
            2: "⚠️ 重要：昨日お伝えできなかった大切なことがあります...",
            3: "🔮 警告：3日以内に行動しないと運気が下降します",
            4: "💫 チャンス：明日までの特別オファーがあります",
            5: "❤️ あなたの運命の人が近づいています",
            6: "⏰ 最終警告：明日で特典が終了します",
            7: "🎊 おめでとうございます！7日間達成特典を解放しました！"
        };

        // ログイン日数の管理
        function updateLoginStreak() {
            const lastLogin = localStorage.getItem('lastLogin');
            const today = new Date().toDateString();
            let loginStreak = parseInt(localStorage.getItem('loginStreak') || '0');
            
            if (lastLogin !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (lastLogin === yesterday.toDateString() || !lastLogin) {
                    loginStreak = Math.min(loginStreak + 1, 7);
                } else {
                    loginStreak = 1;
                }
                
                localStorage.setItem('loginStreak', loginStreak);
                localStorage.setItem('lastLogin', today);
                
                // ボーナス表示
                showDailyBonus(loginStreak);
                
                // 日替わりメッセージ
                if (dailyMessages[loginStreak]) {
                    setTimeout(() => {
                        alert(dailyMessages[loginStreak]);
                    }, 3000);
                }
            }
            
            return loginStreak;
        }

        // ログインボーナス表示
        function showDailyBonus(day) {
            const bonusDiv = document.getElementById('daily-bonus');
            document.getElementById('login-day').textContent = day;
            document.getElementById('days-left').textContent = 7 - day;
            bonusDiv.style.display = 'block';
            
            if (day === 7) {
                bonusDiv.innerHTML += '<p style="color:gold;">🎁 特別鑑定が解放されました！</p>';
            }
        }

        // 紹介コード生成
        function generateReferralCode() {
            const userId = localStorage.getItem('userId') || Math.random().toString(36).substring(2, 8);
            localStorage.setItem('userId', userId);
            const code = 'KICHI' + userId.toUpperCase();
            document.getElementById('referral-code').textContent = code;
            document.getElementById('referral-section').style.display = 'block';
            return code;
        }

        // SNSシェア機能
        function shareTwitter(text = '') {
            const defaultText = text || '【無料占い】KichiCompassで占ったら驚きの結果が...！的中率98.7%の占いを今すぐ試してみて！';
            const url = 'https://ukyou-papa-dev.github.io/kichicompass-new/';
            const hashtags = '占い,無料占い,KichiCompass';
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(defaultText)}&url=${encodeURIComponent(url)}&hashtags=${hashtags}`, '_blank');
            
            trackEvent('share', 'twitter');
        }

        function shareLINE(text = '') {
            const defaultText = text || '【無料占い】KichiCompassがすごい！的中率98.7%の占いを試してみて！';
            const url = 'https://ukyou-papa-dev.github.io/kichicompass-new/';
            window.open(`https://line.me/R/msg/text/?${encodeURIComponent(defaultText + '\n' + url)}`, '_blank');
            
            trackEvent('share', 'line');
        }

        function shareFacebook() {
            const url = 'https://ukyou-papa-dev.github.io/kichicompass-new/';
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
            
            trackEvent('share', 'facebook');
        }

        // 紹介コード付きシェア
        function shareWithCode(platform) {
            const code = document.getElementById('referral-code').textContent;
            const text = `【無料占い】私の紹介コード「${code}」を使うと特別特典がもらえます！KichiCompassで運命を占おう！`;
            
            if (platform === 'twitter') {
                shareTwitter(text);
            } else if (platform === 'line') {
                shareLINE(text);
            }
        }

        // 紹介コードチェック
        function checkReferralCode() {
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            if (refCode) {
                localStorage.setItem('referralCode', refCode);
                alert('紹介コードが適用されました！特別特典を獲得！');
            }
        }

        // カウントダウンタイマー
        setInterval(() => {
            const now = new Date();
            const tonight = new Date();
            tonight.setHours(23, 59, 59);
            const diff = tonight - now;
            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            document.getElementById('countdown').textContent = 
                `⚠️ 初回87%OFF終了まで: ${h}時間${m}分${s}秒`;
        }, 1000);
        
        // 訪問者数
        setInterval(() => {
            const count = 500 + Math.floor(Math.random() * 150);
            document.getElementById('visitors').textContent = 
                `🔴 現在${count}名が鑑定中`;
        }, 3000);
        
        // ポップアップ通知
        setInterval(() => {
            const messages = [
                '東京都のA様が申し込みました',
                '大阪府のK様が有料プランに登録',
                '福岡県のM様が占いを完了',
                '神奈川県のS様がVIPプランに申し込み',
                '愛知県のT様が友達を招待しました'
            ];
            const popup = document.createElement('div');
            popup.className = 'popup';
            popup.textContent = messages[Math.floor(Math.random() * messages.length)];
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 4000);
        }, 8000);

        // 初回訪問ポップアップ
        setTimeout(() => {
            const popup = document.getElementById('special-popup');
            const visitorNum = Math.floor(Math.random() * 100) + 1;
            document.getElementById('visitor-number').textContent = visitorNum;
            popup.style.display = 'block';
        }, 2000);

        // 特別ポップアップを閉じる
        function closeSpecialPopup() {
            document.getElementById('special-popup').style.display = 'none';
            window.location.href = STRIPE_URL;
        }

        // 離脱防止
        let exitIntentShown = false;
        document.addEventListener('mouseout', (e) => {
            if (e.clientY < 10 && !exitIntentShown) {
                exitIntentShown = true;
                document.getElementById('exit-modal').style.display = 'flex';
            }
        });

        // 離脱モーダルを閉じる
        function closeExitModal() {
            document.getElementById('exit-modal').style.display = 'none';
        }

        // Stripeへ移動
        function goToStripe() {
            window.location.href = STRIPE_URL;
        }

        // メール収集
        function captureEmail(e) {
            e.preventDefault();
            const email = e.target[0].value;
            
            let emails = JSON.parse(localStorage.getItem('emails') || '[]');
            emails.push({
                email: email,
                date: new Date().toISOString()
            });
            localStorage.setItem('emails', JSON.stringify(emails));
            
            if (typeof gtag !== 'undefined') {
                gtag('event', 'email_capture', {
                    'event_category': 'engagement'
                });
            }
            
            alert('登録完了！毎日の運勢をお楽しみに！');
            e.target[0].value = '';
            
            document.getElementById('email-capture').style.display = 'none';
        }
        
        // 占い開始
        function startFortune(type) {
            document.getElementById('form-section').style.display = 'block';
            document.getElementById('fortune-selection').style.display = 'none';
            document.getElementById('email-capture').style.display = 'none';
            if(type) localStorage.setItem('fortuneType', type);
            
            if (typeof gtag !== 'undefined') {
                gtag('event', 'fortune_start', {
                    'event_category': 'engagement',
                    'event_label': type || 'general'
                });
            }
        }

        // 占いロジック（既存のコード維持）
        const fortuneTelling = {
            astrology: function(name, birthdate) {
                const date = new Date(birthdate);
                const month = date.getMonth() + 1;
                const day = date.getDate();
                
                let zodiac = '';
                if ((month == 3 && day >= 21) || (month == 4 && day <= 19)) zodiac = '牡羊座';
                else if ((month == 4 && day >= 20) || (month == 5 && day <= 20)) zodiac = '牡牛座';
                else if ((month == 5 && day >= 21) || (month == 6 && day <= 20)) zodiac = '双子座';
                else if ((month == 6 && day >= 21) || (month == 7 && day <= 22)) zodiac = '蟹座';
                else if ((month == 7 && day >= 23) || (month == 8 && day <= 22)) zodiac = '獅子座';
                else if ((month == 8 && day >= 23) || (month == 9 && day <= 22)) zodiac = '乙女座';
                else if ((month == 9 && day >= 23) || (month == 10 && day <= 22)) zodiac = '天秤座';
                else if ((month == 10 && day >= 23) || (month == 11 && day <= 21)) zodiac = '蠍座';
                else if ((month == 11 && day >= 22) || (month == 12 && day <= 21)) zodiac = '射手座';
                else if ((month == 12 && day >= 22) || (month == 1 && day <= 19)) zodiac = '山羊座';
                else if ((month == 1 && day >= 20) || (month == 2 && day <= 18)) zodiac = '水瓶座';
                else zodiac = '魚座';
                
                return `
                    <h2>${name}様は${zodiac}です</h2>
                    <div style="background:rgba(255,255,255,0.1);padding:20px;border-radius:10px;margin:20px 0;">
                        <h3>🌟 恋愛運</h3>
                        <p>${name}様の恋愛運は今、特別な転機を迎えています。</p>
                        <p>${zodiac}の持つ魅力が最大限に発揮される時期です。</p>
                        <p>特に今月の15日前後は重要な出会いの可能性が...</p>
                    </div>
                    <div class="share-buttons">
                        <a href="#" onclick="shareTwitter('私は${zodiac}！KichiCompassで占ったら驚きの結果が！')" class="share-button twitter-share">
                            結果をツイート
                        </a>
                        <a href="#" onclick="shareLINE('私は${zodiac}！すごい占い結果が出た！')" class="share-button line-share">
                            LINEで共有
                        </a>
                    </div>
                    <div style="filter:blur(3px);background:rgba(255,255,255,0.05);padding:20px;border-radius:10px;position:relative;">
                        <p>しかし、${name}様には注意すべき時期があります。</p>
                        <p>金運では驚くべき変化が...</p>
                        <p>健康面では${zodiac}特有の...</p>
                        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.95);padding:20px;border-radius:10px;text-align:center;">
                            <p style="color:gold;font-size:1.2em;">💫 詳細を解放 💫</p>
                            <a href="${STRIPE_URL}" class="cta-button" style="margin-top:10px;">
                                今だけ480円
                            </a>
                        </div>
                    </div>
                `;
            },
            
            tarot: function(name) {
                const cards = [
                    '愚者：新しい始まり',
                    '魔術師：創造力',
                    '女教皇：直感',
                    '女帝：豊穣',
                    '皇帝：権威',
                    '教皇：伝統',
                    '恋人：選択',
                    '戦車：勝利',
                    '力：内なる強さ',
                    '隠者：内省'
                ];
                
                const past = cards[Math.floor(Math.random() * cards.length)];
                const present = cards[Math.floor(Math.random() * cards.length)];
                const future = cards[Math.floor(Math.random() * cards.length)];
                
                return `
                    <h2>${name}様のタロット占い結果</h2>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:20px 0;">
                        <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:10px;">
                            <h4>過去</h4>
                            <p>${past}</p>
                        </div>
                        <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:10px;">
                            <h4>現在</h4>
                            <p>${present}</p>
                        </div>
                        <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:10px;">
                            <h4>未来</h4>
                            <p>${future}</p>
                        </div>
                    </div>
                    <div class="share-buttons">
                        <a href="#" onclick="shareTwitter('タロット占いの結果が衝撃的！')" class="share-button twitter-share">
                            結果をツイート
                        </a>
                        <a href="#" onclick="shareLINE('タロット占いがすごかった！')" class="share-button line-share">
                            LINEで共有
                        </a>
                    </div>
                    <div style="filter:blur(3px);padding:20px;position:relative;">
                        <p>カードが示す${name}様の本当の運命は...</p>
                        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.95);padding:20px;border-radius:10px;">
                            <a href="${STRIPE_URL}" class="cta-button">
                                完全解釈を見る
                            </a>
                        </div>
                    </div>
                `;
            },

            shichu: function(name, birthdate) {
                const date = new Date(birthdate);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                
                const tenkan = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
                const chishi = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
                
                const yearIndex = (year - 4) % 60;
                const tenkanIndex = yearIndex % 10;
                const chishiIndex = yearIndex % 12;
                
                return `
                    <h2>${name}様の四柱推命</h2>
                    <div style="background:rgba(255,255,255,0.1);padding:20px;border-radius:10px;margin:20px 0;">
                        <h3>🐉 あなたの命式</h3>
                        <p>年柱：${tenkan[tenkanIndex]}${chishi[chishiIndex]}</p>
                        <p>${name}様は強い運命の持ち主です。</p>
                        <p>特に金運と仕事運において素晴らしい才能が...</p>
                    </div>
                    <div class="share-buttons">
                        <a href="#" onclick="shareTwitter('四柱推命で驚きの結果が！')" class="share-button twitter-share">
                            結果をツイート
                        </a>
                        <a href="#" onclick="shareLINE('四柱推命がすごい的中率！')" class="share-button line-share">
                            LINEで共有
                        </a>
                    </div>
                    <div style="filter:blur(3px);background:rgba(255,255,255,0.05);padding:20px;border-radius:10px;position:relative;">
                        <p>しかし、${name}様の命式には特別な暗示が...</p>
                        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.95);padding:20px;border-radius:10px;text-align:center;">
                            <p style="color:gold;">💫 完全な命式解析 💫</p>
                            <a href="${STRIPE_URL}" class="cta-button">
                                詳細を見る
                            </a>
                        </div>
                    </div>
                `;
            },

            numerology: function(name, birthdate) {
                const date = new Date(birthdate);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                
                let lifePathNumber = (year + month + day).toString().split('').reduce((a, b) => parseInt(a) + parseInt(b), 0);
                while (lifePathNumber > 9) {
                    lifePathNumber = lifePathNumber.toString().split('').reduce((a, b) => parseInt(a) + parseInt(b), 0);
                }
                
                const meanings = {
                    1: 'リーダーシップと独立',
                    2: '協調と調和',
                    3: '創造性と表現',
                    4: '安定と実践',
                    5: '自由と冒険',
                    6: '愛と責任',
                    7: '探求と内省',
                    8: '成功と物質',
                    9: '奉仕と完成'
                };
                
                return `
                    <h2>${name}様の数秘術</h2>
                    <div style="background:rgba(255,255,255,0.1);padding:20px;border-radius:10px;margin:20px 0;">
                        <h3>🔢 ライフパス数：${lifePathNumber}</h3>
                        <p>意味：${meanings[lifePathNumber]}</p>
                        <p>${name}様の使命は「${meanings[lifePathNumber]}」です。</p>
                    </div>
                    <div class="share-buttons">
                        <a href="#" onclick="shareTwitter('私のライフパス数は${lifePathNumber}！')" class="share-button twitter-share">
                            結果をツイート
                        </a>
                        <a href="#" onclick="shareLINE('数秘術で私の使命がわかった！')" class="share-button line-share">
                            LINEで共有
                        </a>
                    </div>
                    <div style="filter:blur(3px);padding:20px;position:relative;">
                        <p>${name}様と相性の良い人の特徴...</p>
                        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.95);padding:20px;border-radius:10px;">
                            <a href="${STRIPE_URL}" class="cta-button">
                                完全版を見る
                            </a>
                        </div>
                    </div>
                `;
            }
        };
        
        // 結果表示
        function showResult() {
            const name = document.getElementById('name').value || 'あなた';
            const birthdate = document.getElementById('birthdate').value;
            const fortuneType = localStorage.getItem('fortuneType') || 'astrology';
            const referralCode = document.getElementById('referral-input').value;
            
            // 紹介コードチェック
            if (referralCode) {
                alert('紹介コード適用！初回90%OFFでご利用いただけます！');
            }
            
            let resultHTML = '';
            
            switch(fortuneType) {
                case 'astrology':
                    resultHTML = fortuneTelling.astrology(name, birthdate || '2000-01-01');
                    break;
                case 'tarot':
                    resultHTML = fortuneTelling.tarot(name);
                    break;
                case 'shichu':
                    resultHTML = fortuneTelling.shichu(name, birthdate || '2000-01-01');
                    break;
                case 'numerology':
                    resultHTML = fortuneTelling.numerology(name, birthdate || '2000-01-01');
                    break;
                default:
                    resultHTML = fortuneTelling.astrology(name, birthdate || '2000-01-01');
            }
            
            document.getElementById('result-section').style.display = 'block';
            document.getElementById('result-section').innerHTML = `
                <div style="max-width:800px;margin:0 auto;padding:20px;">
                    ${resultHTML}
                </div>
            `;
            
            document.getElementById('form-section').style.display = 'none';
            
            // 結果を保存
            const results = JSON.parse(localStorage.getItem('fortuneResults') || '[]');
            results.push({
                name: name,
                type: fortuneType,
                date: new Date().toISOString()
            });
            localStorage.setItem('fortuneResults', JSON.stringify(results));

            if (typeof gtag !== 'undefined') {
                gtag('event', 'fortune_complete', {
                    'event_category': 'engagement',
                    'event_label': fortuneType
                });
            }
        }

        // ページ読み込み時の初期化
        window.addEventListener('load', function() {
            updateLoginStreak();
            generateReferralCode();
            checkReferralCode();
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KichiCompass - あなただけの運命の羅針盤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Helvetica Neue', Arial, sans-serif;
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* ステップ表示 */
        .step {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }
        
        .step.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 神秘的なタイトル */
        .title {
            text-align: center;
            font-size: 28px;
            margin: 40px 0;
            text-shadow: 0 0 20px rgba(255,255,255,0.5);
            animation: glow 2s ease-in-out infinite;
        }
        
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 20px rgba(255,255,255,0.5); }
            50% { text-shadow: 0 0 30px rgba(255,255,255,0.8); }
        }
        
        /* 入力フォーム */
        .input-group {
            margin: 30px 0;
        }
        
        .input-label {
            display: block;
            margin-bottom: 10px;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .input-field {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 16px;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }
        
        .input-field::placeholder {
            color: rgba(255,255,255,0.6);
        }
        
        .input-field:focus {
            outline: none;
            background: rgba(255,255,255,0.3);
            box-shadow: 0 0 30px rgba(255,255,255,0.3);
        }
        
        /* 魔法のボタン */
        .magic-button {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }
        
        .magic-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }
        
        .magic-button:active {
            transform: translateY(0);
        }
        
        /* ローディングアニメーション */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 16px;
            opacity: 0.9;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 0.5; }
        }
        
        /* 仮診断結果 */
        .preview-result {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .result-title {
            font-size: 20px;
            margin-bottom: 15px;
            color: #ffd700;
        }
        
        .result-text {
            line-height: 1.8;
            opacity: 0.95;
        }
        
        .blur-text {
            filter: blur(3px);
            user-select: none;
            position: relative;
        }
        
        .unlock-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            padding: 15px 25px;
            border-radius: 10px;
            white-space: nowrap;
        }
        
        /* 緊急性を煽る要素 */
        .urgency-banner {
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            padding: 10px;
            text-align: center;
            border-radius: 10px;
            margin: 20px 0;
            animation: blink 2s ease-in-out infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .countdown {
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
            text-align: center;
            margin: 20px 0;
        }
        
        /* 社会的証明 */
        .social-proof {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-size: 14px;
        }
        
        .user-count {
            font-size: 20px;
            color: #ffd700;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ステップ1: 名前入力 -->
        <div class="step active" id="step1">
            <h1 class="title">✨ あなたの運命が呼んでいます ✨</h1>
            
            <div class="social-proof">
                現在 <span class="user-count" id="activeUsers">2,847</span> 人が鑑定中
            </div>
            
            <div class="input-group">
                <label class="input-label">あなたのお名前を教えてください</label>
                <input type="text" class="input-field" id="userName" placeholder="ニックネームでもOK" autocomplete="off">
            </div>
            
            <button class="magic-button" onclick="processStep1()">
                無料で運命を確認する →
            </button>
            
            <div class="urgency-banner">
                ⚡ 本日限定！通常3,980円→完全無料 ⚡
            </div>
        </div>
        
        <!-- ローディング画面 -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">
                宇宙からメッセージを受信中...
            </div>
        </div>
        
        <!-- ステップ2: 仮診断結果 -->
        <div class="step" id="step2">
            <h1 class="title">🌟 <span id="displayName"></span>様の運命 🌟</h1>
            
            <div class="preview-result">
                <div class="result-title">⚡ 緊急メッセージ</div>
                <div class="result-text" id="previewMessage"></div>
            </div>
            
            <div class="preview-result">
                <div class="result-title">💕 恋愛運</div>
                <div class="result-text">
                    <span id="lovePreview"></span>
                    <div class="blur-text">
                        実は、あなたのことを密かに想っている人が...
                        <div class="unlock-overlay">🔒 詳細を見るには生年月日が必要</div>
                    </div>
                </div>
            </div>
            
            <div class="countdown" id="countdown">
                詳細診断まで残り: <span id="timer">05:00</span>
            </div>
            
            <div class="input-group">
                <label class="input-label">より正確な診断のために生年月日を入力</label>
                <input type="date" class="input-field" id="birthDate">
            </div>
            
            <button class="magic-button" onclick="processStep2()">
                完全版を今すぐ確認する →
            </button>
        </div>
        
        <!-- ステップ3: 最終フック -->
        <div class="step" id="step3">
            <h1 class="title">⚠️ 重要な警告 ⚠️</h1>
            
            <div class="preview-result">
                <div class="result-title">🔮 <span id="finalName"></span>様だけへの特別なメッセージ</div>
                <div class="result-text" id="criticalMessage"></div>
            </div>
            
            <div class="preview-result">
                <div class="blur-text" style="padding: 20px;">
                    今後3日以内に、あなたの人生を大きく変える出来事が...
                    しかし、1つ間違えると取り返しのつかないことに...
                    <div class="unlock-overlay">🔓 続きを読む（480円）</div>
                </div>
            </div>
            
            <button class="magic-button" style="background: linear-gradient(45deg, #ffd700, #ffed4e);" onclick="processPayment()">
                今すぐ全てを知る（特別価格480円）
            </button>
            
            <div class="social-proof" style="margin-top: 20px;">
                ⭐ 98.7%の方が「人生が変わった」と回答
            </div>
        </div>
    </div>
    
    <script>
        // ユーザーデータ保存
        let userData = {
            name: '',
            birthDate: '',
            startTime: new Date(),
            step: 1
        };
        
        // 偽のアクティブユーザー数を動的に変更
        setInterval(() => {
            const users = document.getElementById('activeUsers');
            if (users) {
                const current = parseInt(users.textContent);
                const change = Math.floor(Math.random() * 50) - 25;
                users.textContent = Math.max(2000, current + change).toLocaleString();
            }
        }, 3000);
        
        // ステップ1処理
        function processStep1() {
            const name = document.getElementById('userName').value;
            if (!name) {
                alert('お名前を入力してください');
                return;
            }
            
            userData.name = name;
            localStorage.setItem('userData', JSON.stringify(userData));
            
            // ローディング演出
            showLoading();
            
            setTimeout(() => {
                hideLoading();
                showStep2(name);
            }, 3000);
        }
        
        // ローディング表示
        function showLoading() {
            document.getElementById('step1').classList.remove('active');
            document.getElementById('loading').classList.add('active');
            
            // ローディングテキストを変更
            const texts = [
                '宇宙からメッセージを受信中...',
                'あなたの運命を解析中...',
                '守護霊と交信中...',
                '特別な結果が見つかりました！'
            ];
            
            let index = 0;
            const interval = setInterval(() => {
                document.getElementById('loadingText').textContent = texts[index];
                index++;
                if (index >= texts.length) {
                    clearInterval(interval);
                }
            }, 700);
        }
        
        // ローディング非表示
        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }
        
        // ステップ2表示
        function showStep2(name) {
            document.getElementById('step2').classList.add('active');
            document.getElementById('displayName').textContent = name;
            
            // パーソナライズされたメッセージ
            const messages = [
                `${name}様、実は昨日からあなたのことが気になっていました...`,
                `${name}様に今すぐ伝えなければならないことがあります...`,
                `${name}様の周りで大きな変化が起きようとしています...`
            ];
            
            const loveMessages = [
                '現在、恋愛運が急上昇中！',
                '運命の人との出会いが近づいています',
                '今月は恋愛における重要な転機'
            ];
            
            document.getElementById('previewMessage').textContent = 
                messages[Math.floor(Math.random() * messages.length)];
            
            document.getElementById('lovePreview').textContent = 
                loveMessages[Math.floor(Math.random() * loveMessages.length)];
            
            // カウントダウン開始
            startCountdown();
        }
        
        // カウントダウンタイマー
        function startCountdown() {
            let seconds = 300; // 5分
            const timer = setInterval(() => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                document.getElementById('timer').textContent = 
                    `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                seconds--;
                
                if (seconds < 0) {
                    clearInterval(timer);
                    document.getElementById('timer').textContent = '00:00';
                    document.getElementById('countdown').innerHTML = 
                        '<span style="color: #ff6b6b;">⚠️ 時間切れ！特別オファーが終了しました</span>';
                }
            }, 1000);
        }
        
        // ステップ2処理
        function processStep2() {
            const birthDate = document.getElementById('birthDate').value;
            if (!birthDate) {
                alert('生年月日を入力してください');
                return;
            }
            
            userData.birthDate = birthDate;
            userData.step = 3;
            localStorage.setItem('userData', JSON.stringify(userData));
            
            showLoading();
            
            setTimeout(() => {
                hideLoading();
                showStep3();
            }, 3000);
        }
        
        // ステップ3表示
        function showStep3() {
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.add('active');
            document.getElementById('finalName').textContent = userData.name;
            
            // 緊急性の高いメッセージ
            const criticalMessages = [
                `${userData.name}様、これは偶然ではありません。今このタイミングでこのメッセージを読んでいるのには深い意味があります。`,
                `実は、${userData.name}様の運命に関わる重要な転機が訪れています。しかし、正しい選択をしないと...`,
                `${userData.name}様の守護霊が強く警告しています。今すぐ行動を起こさないと、大切なチャンスを逃すことに...`
            ];
            
            document.getElementById('criticalMessage').textContent = 
                criticalMessages[Math.floor(Math.random() * criticalMessages.length)];
        }
        
        // 決済処理
        function processPayment() {
            userData.converted = true;
            userData.conversionTime = new Date();
            localStorage.setItem('userData', JSON.stringify(userData));
            
            // ここにStripe決済処理を実装
            alert('決済画面へ移動します（Stripe実装箇所）');
        }
        
        // 離脱防止
        window.addEventListener('beforeunload', (e) => {
            if (userData.step > 1 && !userData.converted) {
                e.preventDefault();
                e.returnValue = '本当に離れますか？特別な診断結果が消えてしまいます...';
            }
        });
        
        // ページ読み込み時の処理
        window.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('userData');
            if (saved) {
                userData = JSON.parse(saved);
                // 前回の続きから開始
                if (userData.step === 2) {
                    document.getElementById('step1').classList.remove('active');
                    showStep2(userData.name);
                } else if (userData.step === 3) {
                    document.getElementById('step1').classList.remove('active');
                    showStep3();
                }
            }
        });
    </script>
</body>
</html>
<!-- 既存のHTMLの</body>タグの前に追加 -->
<script>
// ==========================================
// 依存化トリガー文言システム
// ==========================================

const DependencyTriggers = {
    // 時間帯別メッセージ（個別感を演出）
    getTimeBasedMessage(name) {
        const hour = new Date().getHours();
        const messages = {
            morning: [ // 5-11時
                `おはようございます、${name}様。実は昨夜、${name}様の夢を見ました...重要なメッセージがあります`,
                `${name}様、朝一番にお伝えしたいことが...今日は特別な一日になりそうです`,
                `朝の澄んだ空気の中、${name}様だけに伝わるメッセージを受け取りました`
            ],
            afternoon: [ // 11-17時
                `${name}様、お忙しい中すみません。でも今伝えないと手遅れに...`,
                `午後の運気が急変しています、${name}様。今すぐ確認が必要です`,
                `${name}様の守護霊が、緊急で伝えたいことがあるようです`
            ],
            evening: [ // 17-22時
                `${name}様、今夜が運命の分かれ道です。慎重に行動してください`,
                `夕暮れ時の今、${name}様にとって重要な転機が訪れています`,
                `${name}様、明日の朝までに決断すべきことがあります...`
            ],
            night: [ // 22-5時
                `夜分遅くに失礼します、${name}様。でも、これだけは今伝えなければ...`,
                `${name}様、眠る前に知っておくべき重要なことがあります`,
                `深夜のメッセージには特別な意味が...${name}様だけに`
            ]
        };
        
        let timeMessages;
        if (hour >= 5 && hour < 11) timeMessages = messages.morning;
        else if (hour >= 11 && hour < 17) timeMessages = messages.afternoon;
        else if (hour >= 17 && hour < 22) timeMessages = messages.evening;
        else timeMessages = messages.night;
        
        return timeMessages[Math.floor(Math.random() * timeMessages.length)];
    },
    
    // 不安を煽る文言
    anxietyTriggers: {
        relationship: [
            "なぜあなただけが、こんなに恋愛で苦しまなければならないのか...",
            "相手の本当の気持ち、実は思っているのと正反対かもしれません...",
            "このままでは、3ヶ月以内に関係が終わってしまう可能性が...",
            "今、相手の周りに危険な影が...ライバルの存在を示唆しています",
            "彼/彼女があなたに隠している重大な秘密があります...",
            "実は、あなたの知らないところで重要な変化が起きています"
        ],
        career: [
            "今の職場に、あなたの成功を妨げる人物が...",
            "このまま何もしなければ、キャリアは停滞期に入ります",
            "上司があなたについて、裏で話していることを知っていますか？",
            "転職のベストタイミングを逃すと、5年は遅れることに...",
            "あなたの才能が正当に評価されていない本当の理由...",
            "近いうちに、職場で大きな変化が...準備はできていますか？"
        ],
        health: [
            "最近の不調には、スピリチュアルな原因が...",
            "あなたのオーラに、不穏な影が見えます",
            "エネルギーバランスが崩れています。このままでは...",
            "守護霊が、あなたの健康について警告しています",
            "今月は特に注意が必要な時期。油断すると...",
            "あなたの体が発している重要なサインを見逃していませんか？"
        ],
        money: [
            "金運が急降下する前兆が...今すぐ対策が必要です",
            "お金のトラブルに巻き込まれる可能性が高まっています",
            "投資や大きな買い物は、今は絶対に避けるべき理由が...",
            "あなたの財布から、エネルギーが漏れています",
            "今月の出費に要注意。思わぬ落とし穴が...",
            "金運を下げている意外な原因を知っていますか？"
        ]
    },
    
    // 期待を煽る文言
    hopeTriggers: {
        relationship: [
            "実は、あなたのことを密かに想っている人が、すぐ近くに...",
            "運命の人との出会いまで、あと少し...その人の特徴は...",
            "来月、恋愛運が劇的に上昇！ただし、ある行動を取れば...",
            "両思いになれる可能性：87%！成功の鍵は...",
            "復縁のチャンスが巡ってきています。タイミングは...",
            "あなたの魅力が最高潮に！今がアプローチのベストタイミング"
        ],
        career: [
            "大きなチャンスが目前に！掴むための準備は...",
            "あなたの才能が認められる時が、ついに来ました",
            "昇進・昇給の可能性が急上昇中！重要なのは...",
            "理想の職場との出会いが近づいています",
            "あなたの隠れた才能が開花する時期が...",
            "成功への扉が開きかけています。鍵となる日付は..."
        ],
        money: [
            "臨時収入の暗示が！金額はなんと...",
            "金運爆上げの前兆が現れています",
            "宝くじ・懸賞運が最高潮に！買うべき日は...",
            "お金の流れが変わり始めています。良い方向に...",
            "投資のベストタイミングが近づいています",
            "あなたの金運を10倍にする方法が..."
        ]
    },
    
    // 緊急性を演出する文言
    urgencyTriggers: [
        "⚠️ 24時間以内に行動しないと、チャンスを逃します",
        "🚨 今日の23:59までが運命の分岐点",
        "⏰ あと3時間で運気が変わります。今すぐ確認を",
        "📍 この瞬間を逃すと、次のチャンスは3ヶ月後...",
        "🔥 緊急警告：明日では手遅れになることが...",
        "⚡ 今すぐ行動すれば間に合います！残り時間は..."
    ],
    
    // 依存を深める文言（毎日チェックさせる）
    dailyHooks: [
        "昨日お伝えした重要な件の続きが...",
        "新たな展開が！昨日とは状況が一変しています",
        "守護霊から追加のメッセージが届いています",
        "運命の流れに変化が...今日の行動が鍵を握ります",
        "昨日の診断結果を更新する必要があります",
        "24時間で運気が激変！最新の状況は..."
    ],
    
    // 課金を促す文言
    paymentTriggers: {
        soft: [
            "より詳しい内容を知りたい方は...",
            "完全版では、さらに具体的な日付と対策が...",
            "プレミアム診断で、100%の真実を..."
        ],
        medium: [
            "この先の重要な情報は、特別会員様限定です",
            "あと少しで全てが明らかに...続きを見るには",
            "核心部分については、詳細診断でお伝えします"
        ],
        hard: [
            "⚠️ これ以上は無料では危険すぎてお伝えできません",
            "🔒 重要すぎる内容のため、真剣な方のみに公開",
            "💎 あなただけの特別な診断結果を解放するには..."
        ]
    },
    
    // 感情の振れ幅を作る（ジェットコースター効果）
    emotionalRollercoaster(day) {
        const patterns = [
            { day: 'Monday', type: 'positive', message: '週の始まりは最高のスタート！全てがうまくいく日' },
            { day: 'Tuesday', type: 'warning', message: '要注意...トラブルの暗示が。慎重に行動を' },
            { day: 'Wednesday', type: 'opportunity', message: '大チャンス到来！今日の決断が未来を変える' },
            { day: 'Thursday', type: 'negative', message: '試練の日。でも、乗り越えれば...' },
            { day: 'Friday', type: 'positive', message: '運気急上昇！願いが叶う金曜日' },
            { day: 'Saturday', type: 'mystery', message: '予測不能な土曜日。何かが起こる予感...' },
            { day: 'Sunday', type: 'revelation', message: '真実が明らかになる日曜日。準備はいいですか？' }
        ];
        
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const today = days[day];
        return patterns.find(p => p.day === today) || patterns[0];
    }
};

// ==========================================
// 動的にトリガーを挿入する関数
// ==========================================

function injectTriggers() {
    const name = userData.name || 'あなた';
    
    // 1. 時間帯別メッセージを挿入
    const timeMessage = DependencyTriggers.getTimeBasedMessage(name);
    
    // 2. カテゴリー別の不安・期待を組み合わせる
    const anxietyMsg = DependencyTriggers.anxietyTriggers.relationship[
        Math.floor(Math.random() * DependencyTriggers.anxietyTriggers.relationship.length)
    ];
    
    const hopeMsg = DependencyTriggers.hopeTriggers.relationship[
        Math.floor(Math.random() * DependencyTriggers.hopeTriggers.relationship.length)
    ];
    
    // 3. 緊急性メッセージ
    const urgencyMsg = DependencyTriggers.urgencyTriggers[
        Math.floor(Math.random() * DependencyTriggers.urgencyTriggers.length)
    ];
    
    // 4. 今日の感情パターン
    const todayPattern = DependencyTriggers.emotionalRollercoaster(new Date().getDay());
    
    return {
        timeMessage,
        anxietyMsg,
        hopeMsg,
        urgencyMsg,
        todayPattern
    };
}

// ==========================================
// プッシュ通知風のメッセージ表示
// ==========================================

function showNotification(message, type = 'warning') {
    const notification = document.createElement('div');
    notification.className = 'push-notification';
    notification.innerHTML = `
        <div class="notification-icon">${type === 'warning' ? '⚠️' : '✨'}</div>
        <div class="notification-text">${message}</div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 100);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

// ==========================================
// 自動トリガー発動システム
// ==========================================

let triggerInterval;

function startTriggerSystem() {
    // 初回は即座に表示
    const triggers = injectTriggers();
    
    // 30秒後に不安メッセージ
    setTimeout(() => {
        showNotification(triggers.anxietyMsg, 'warning');
    }, 30000);
    
    // 60秒後に期待メッセージ
    setTimeout(() => {
        showNotification(triggers.hopeMsg, 'hope');
    }, 60000);
    
    // 90秒後に緊急メッセージ
    setTimeout(() => {
        showNotification(triggers.urgencyMsg, 'warning');
    }, 90000);
    
    // 3分ごとにランダムなトリガーを表示
    triggerInterval = setInterval(() => {
        const randomTriggers = injectTriggers();
        const messageTypes = ['anxietyMsg', 'hopeMsg', 'urgencyMsg'];
        const selectedType = messageTypes[Math.floor(Math.random() * messageTypes.length)];
        showNotification(randomTriggers[selectedType], selectedType === 'hopeMsg' ? 'hope' : 'warning');
    }, 180000);
}

// ==========================================
// 離脱時の最終トリガー
// ==========================================

let exitIntentShown = false;

document.addEventListener('mouseleave', (e) => {
    if (e.clientY <= 0 && !exitIntentShown && !userData.converted) {
        exitIntentShown = true;
        showExitPopup();
    }
});

function showExitPopup() {
    const popup = document.createElement('div');
    popup.className = 'exit-popup';
    popup.innerHTML = `
        <div class="exit-popup-content">
            <h2>😱 ちょっと待って！</h2>
            <p class="exit-main-message">
                ${userData.name}様の運命の転機まで<br>
                <span class="countdown-large">あと12時間</span>
            </p>
            <div class="exit-warning">
                ⚠️ 今離れると、この特別な診断結果は二度と見られません
            </div>
            <div class="exit-offer">
                <div class="offer-badge">最後のチャンス</div>
                <div class="offer-price">
                    <span class="original-price">通常3,980円</span>
                    <span class="arrow">→</span>
                    <span class="special-price">今だけ480円</span>
                </div>
            </div>
            <button class="exit-cta" onclick="acceptExitOffer()">
                運命を確認する（87%OFF）
            </button>
            <button class="exit-close" onclick="closeExitPopup()">
                本当に諦める
            </button>
        </div>
    `;
    
    document.body.appendChild(popup);
    setTimeout(() => popup.classList.add('show'), 100);
}

function acceptExitOffer() {
    closeExitPopup();
    processPayment();
}

function closeExitPopup() {
    const popup = document.querySelector('.exit-popup');
    if (popup) {
        popup.classList.remove('show');
        setTimeout(() => popup.remove(), 300);
    }
}

// ==========================================
// ページ読み込み時に自動開始
// ==========================================

document.addEventListener('DOMContentLoaded', () => {
    // 既存のユーザーデータがあれば、即座にトリガー開始
    if (userData.name) {
        startTriggerSystem();
    }
});

// ==========================================
// 診断結果にトリガーを動的に挿入
// ==========================================

function enhanceResultsWithTriggers(originalText) {
    const triggers = injectTriggers();
    
    // オリジナルテキストの前後にトリガーを追加
    const enhancedText = `
        <div class="trigger-warning">${triggers.urgencyMsg}</div>
        <div class="main-result">${originalText}</div>
        <div class="trigger-anxiety">${triggers.anxietyMsg}</div>
        <div class="trigger-hope">でも大丈夫...${triggers.hopeMsg}</div>
        <div class="trigger-cta">
            <button onclick="processPayment()">
                完全な答えを知る（480円）
            </button>
        </div>
    `;
    
    return enhancedText;
}
</script>

<!-- 追加CSS -->
<style>
/* プッシュ通知風のスタイル */
.push-notification {
    position: fixed;
    top: 20px;
    right: -400px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    gap: 15px;
    max-width: 350px;
    transition: right 0.3s ease;
    z-index: 10000;
}

.push-notification.show {
    right: 20px;
}

.notification-icon {
    font-size: 24px;
}

.notification-text {
    flex: 1;
    font-size: 14px;
    line-height: 1.4;
}

/* 離脱ポップアップ */
.exit-popup {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 99999;
}

.exit-popup.show {
    opacity: 1;
}

.exit-popup-content {
    background: white;
    border-radius: 20px;
    padding: 40px;
    max-width: 500px;
    text-align: center;
    color: #333;
    position: relative;
    animation: shake 0.5s ease;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
}

.exit-popup h2 {
    color: #ff6b6b;
    margin-bottom: 20px;
    font-size: 32px;
}

.exit-main-message {
    font-size: 18px;
    margin: 20px 0;
    line-height: 1.6;
}

.countdown-large {
    font-size: 36px;
    color: #ff6b6b;
    font-weight: bold;
    display: block;
    margin: 10px 0;
}

.exit-warning {
    background: #fff3cd;
    color: #856404;
    padding: 15px;
    border-radius: 10px;
    margin: 20px 0;
    border: 2px solid #ffc107;
}

.exit-offer {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
}

.offer-badge {
    background: #ffd700;
    color: #333;
    padding: 5px 15px;
    border-radius: 20px;
    display: inline-block;
    margin-bottom: 10px;
    font-weight: bold;
}

.offer-price {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    font-size: 24px;
}

.original-price {
    text-decoration: line-through;
    opacity: 0.7;
}

.special-price {
    color: #ffd700;
    font-weight: bold;
    font-size: 32px;
}

.exit-cta {
    background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
    color: white;
    border: none;
    padding: 20px 40px;
    border-radius: 50px;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
    margin: 10px;
    transition: transform 0.3s ease;
}

.exit-cta:hover {
    transform: scale(1.05);
}

.exit-close {
    background: transparent;
    color: #999;
    border: none;
    padding: 10px;
    cursor: pointer;
    text-decoration: underline;
    margin-top: 10px;
}

/* トリガー強調スタイル */
.trigger-warning {
    background: #ff6b6b;
    color: white;
    padding: 10px;
    border-radius: 5px;
    margin: 10px 0;
    animation: pulse 2s infinite;
}

.trigger-anxiety {
    color: #ff6b6b;
    font-weight: bold;
    margin: 15px 0;
}

.trigger-hope {
    color: #4CAF50;
    font-weight: bold;
    margin: 15px 0;
}

.trigger-cta button {
    background: linear-gradient(45deg, #ffd700, #ffed4e);
    color: #333;
    border: none;
    padding: 15px 30px;
    border-radius: 50px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    animation: glow 2s infinite;
    margin: 20px 0;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

@keyframes glow {
    0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
    50% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.8); }
}
</style>
<!-- 既存のHTMLの</body>タグの前に追加 -->
<script>
// ==========================================
// 段階的課金システム - 究極の心理操作
// ==========================================

const PaymentPsychology = {
    // 課金段階の定義（徐々に高額に）
    stages: [
        {
            level: 1,
            price: 480,
            originalPrice: 3980,
            discount: 88,
            title: "お試し診断",
            description: "基本的な運勢を確認",
            bait: "あなたの運命の30%が明らかに...",
            urgency: "初回限定価格",
            timer: 300 // 5分
        },
        {
            level: 2,
            price: 980,
            originalPrice: 4980,
            discount: 80,
            title: "詳細診断",
            description: "恋愛・金運の詳細",
            bait: "さらに40%の真実が...",
            urgency: "2回目の特別価格",
            timer: 600 // 10分
        },
        {
            level: 3,
            price: 1980,
            originalPrice: 5980,
            discount: 67,
            title: "完全診断",
            description: "全ての運勢を網羅",
            bait: "残り30%には衝撃の事実が...",
            urgency: "今だけの特別オファー",
            timer: 900 // 15分
        },
        {
            level: 4,
            price: 2980,
            originalPrice: 9800,
            discount: 70,
            title: "プレミアム診断",
            description: "1ヶ月の完全予測",
            bait: "未来の具体的な日付が判明...",
            urgency: "VIP限定価格",
            timer: 1200 // 20分
        },
        {
            level: 5,
            price: 4980,
            originalPrice: 19800,
            discount: 75,
            title: "マスター診断",
            description: "3ヶ月の運命マップ",
            bait: "人生を変える決定的な情報...",
            urgency: "最終オファー",
            timer: 1800 // 30分
        },
        {
            level: 6,
            price: 9800,
            originalPrice: 39800,
            discount: 75,
            title: "年間プログラム",
            description: "1年間の完全サポート",
            bait: "もう占いで迷うことはありません...",
            urgency: "究極の投資",
            timer: 3600 // 60分
        },
        {
            level: 7,
            price: 980,
            originalPrice: 2980,
            discount: 67,
            title: "月額プラン",
            description: "毎月自動更新",
            bait: "永続的な安心を手に入れる...",
            urgency: "サブスクリプション",
            timer: null // 無制限
        }
    ],

    // 現在の課金レベル
    currentLevel: 0,

    // 累計課金額
    totalSpent: 0,

    // 結果の分割表示システム
    resultParts: {
        free: {
            title: "無料診断結果",
            content: [
                "基本性格",
                "今日の運勢（簡易版）"
            ],
            locked: 5
        },
        level1: {
            title: "運命の扉 - 第1章",
            content: [
                "恋愛運の真実",
                "隠された才能"
            ],
            locked: 4
        },
        level2: {
            title: "運命の扉 - 第2章",
            content: [
                "金運の転機",
                "人間関係の秘密"
            ],
            locked: 3
        },
        level3: {
            title: "運命の扉 - 第3章",
            content: [
                "健康運の警告",
                "キャリアの分岐点"
            ],
            locked: 2
        },
        level4: {
            title: "運命の扉 - 最終章",
            content: [
                "未来の具体的な日付",
                "避けるべき危険日",
                "最高の幸運日"
            ],
            locked: 0
        }
    },

    // サンクコストを可視化
    showInvestment() {
        return `
            <div class="investment-tracker">
                <div class="investment-label">あなたの運命への投資</div>
                <div class="investment-amount">¥${this.totalSpent.toLocaleString()}</div>
                <div class="investment-progress">
                    <div class="progress-bar" style="width: ${Math.min(this.currentLevel * 14.3, 100)}%"></div>
                </div>
                <div class="investment-message">
                    ${this.getInvestmentMessage()}
                </div>
            </div>
        `;
    },

    // 投資額に応じたメッセージ
    getInvestmentMessage() {
        if (this.totalSpent === 0) return "運命の扉を開く準備はできていますか？";
        if (this.totalSpent < 1000) return "運命が動き始めました...";
        if (this.totalSpent < 3000) return "真実に近づいています...";
        if (this.totalSpent < 5000) return "もう少しで全てが明らかに...";
        if (this.totalSpent < 10000) return "運命の核心に到達しました";
        return "あなたは選ばれし者です";
    },

    // 段階的な価格表示
    showPricing(level) {
        const stage = this.stages[level];
        const html = `
            <div class="pricing-card ${level === this.currentLevel ? 'current' : ''} ${level < this.currentLevel ? 'completed' : ''}">
                ${level === this.currentLevel ? '<div class="recommended-badge">今ここ！</div>' : ''}
                ${level === 0 ? '<div class="popular-badge">🔥 93%の人が選択</div>' : ''}
                
                <h3 class="pricing-title">${stage.title}</h3>
                <p class="pricing-description">${stage.description}</p>
                
                <div class="pricing-amount">
                    <span class="original-price">¥${stage.originalPrice.toLocaleString()}</span>
                    <span class="discount-badge">${stage.discount}%OFF</span>
                </div>
                
                <div class="final-price">
                    <span class="currency">¥</span>
                    <span class="price-number">${stage.price.toLocaleString()}</span>
                </div>
                
                <div class="pricing-bait">${stage.bait}</div>
                
                ${stage.timer ? `
                    <div class="countdown-timer" data-timer="${stage.timer}">
                        <span class="timer-label">${stage.urgency}</span>
                        <span class="timer-display">00:00</span>
                    </div>
                ` : ''}
                
                <button class="purchase-button" onclick="PaymentPsychology.processPurchase(${level})">
                    ${level === 6 ? '月額プランで始める' : '今すぐ解放する'}
                </button>
                
                ${level === this.currentLevel && this.currentLevel > 0 ? `
                    <div class="sunk-cost-reminder">
                        既に¥${this.totalSpent.toLocaleString()}投資済み。今やめたら全てが無駄に...
                    </div>
                ` : ''}
            </div>
        `;
        return html;
    },

    // 購入処理
    processPurchase(level) {
        const stage = this.stages[level];
        
        // アニメーション演出
        this.showProcessingAnimation();
        
        setTimeout(() => {
            // 課金額を追加
            this.totalSpent += stage.price;
            this.currentLevel = Math.max(this.currentLevel, level + 1);
            
            // LocalStorageに保存
            localStorage.setItem('paymentLevel', this.currentLevel);
            localStorage.setItem('totalSpent', this.totalSpent);
            
            // 結果を段階的に表示
            this.revealResults(level);
            
            // 次の課金への誘導
            if (level < 5) {
                setTimeout(() => {
                    this.showNextOffer(level + 1);
                }, 3000);
            } else if (level === 5) {
                // 最終段階：サブスクへ誘導
                this.showSubscriptionOffer();
            }
        }, 2000);
    },

    // 処理中アニメーション
    showProcessingAnimation() {
        const overlay = document.createElement('div');
        overlay.className = 'processing-overlay';
        overlay.innerHTML = `
            <div class="processing-content">
                <div class="processing-spinner"></div>
                <div class="processing-text">運命を解析中...</div>
                <div class="processing-subtext">あなただけの特別な結果を準備しています</div>
            </div>
        `;
        document.body.appendChild(overlay);
        
        setTimeout(() => {
            overlay.classList.add('show');
        }, 100);
    },

    // 結果の段階的表示
    revealResults(level) {
        const overlay = document.querySelector('.processing-overlay');
        if (overlay) {
            overlay.classList.remove('show');
            setTimeout(() => overlay.remove(), 300);
        }

        const resultsHTML = `
            <div class="revealed-results">
                <h2 class="results-title">🎉 新たな真実が明らかになりました！</h2>
                
                <div class="results-content">
                    ${this.generateResults(level)}
                </div>
                
                <div class="results-teaser">
                    <h3>しかし、まだ隠された真実が...</h3>
                    <div class="locked-content">
                        ${this.generateLockedContent(level)}
                    </div>
                </div>
                
                ${this.showInvestment()}
            </div>
        `;

        // 結果を表示
        const container = document.getElementById('step3') || document.body;
        container.innerHTML = resultsHTML;
    },

    // レベルに応じた結果生成
    generateResults(level) {
        const templates = {
            0: `
                <div class="result-item">
                    <span class="result-emoji">💕</span>
                    <span class="result-text">あなたの恋愛運は上昇中！特に${this.getRandomDay()}が重要な日になりそうです。</span>
                </div>
            `,
            1: `
                <div class="result-item">
                    <span class="result-emoji">💰</span>
                    <span class="result-text">金運に大きな変化が！${this.getRandomAmount()}円の臨時収入の可能性が...</span>
                </div>
            `,
            2: `
                <div class="result-item">
                    <span class="result-emoji">🌟</span>
                    <span class="result-text">あなたの隠れた才能「${this.getRandomTalent()}」が開花する時期が近づいています。</span>
                </div>
            `,
            3: `
                <div class="result-item">
                    <span class="result-emoji">⚠️</span>
                    <span class="result-text">注意！${this.getRandomWarning()}を避けることで、大きなトラブルを回避できます。</span>
                </div>
            `,
            4: `
                <div class="result-item">
                    <span class="result-emoji">🎯</span>
                    <span class="result-text">運命の転機：${this.getRandomDate()}にあなたの人生を変える出来事が起こります。</span>
                </div>
            `,
            5: `
                <div class="result-item">
                    <span class="result-emoji">🔮</span>
                    <span class="result-text">完全なる真実：あなたの使命は「${this.getRandomMission()}」です。</span>
                </div>
            `
        };
        
        return templates[level] || templates[0];
    },

    // ロックされたコンテンツの表示
    generateLockedContent(level) {
        if (level >= 5) {
            return `<div class="all-unlocked">✨ 全ての真実が明らかになりました！</div>`;
        }

        const locked = 5 - level;
        let content = '';
        
        for (let i = 0; i < locked; i++) {
            content += `
                <div class="locked-item">
                    <span class="lock-icon">🔒</span>
                    <span class="locked-text">重要な情報がロックされています...</span>
                </div>
            `;
        }
        
        return content;
    },

    // 次のオファーを表示
    showNextOffer(nextLevel) {
        if (nextLevel >= this.stages.length) return;

        const modal = document.createElement('div');
        modal.className = 'next-offer-modal';
        modal.innerHTML = `
            <div class="offer-modal-content">
                <div class="offer-header">
                    <h2>まだ終わりではありません...</h2>
                    <p>さらに深い真実があなたを待っています</p>
                </div>
                
                ${this.showPricing(nextLevel)}
                
                <button class="skip-button" onclick="PaymentPsychology.closeOffer()">
                    今は結構です（本当に？）
                </button>
            </div>
        `;
        
        document.body.appendChild(modal);
        setTimeout(() => modal.classList.add('show'), 100);
        
        // タイマー開始
        this.startTimer(nextLevel);
    },

    // サブスクリプションオファー
    showSubscriptionOffer() {
        const modal = document.createElement('div');
        modal.className = 'subscription-modal';
        modal.innerHTML = `
            <div class="subscription-content">
                <div class="subscription-header">
                    <h1>🎊 おめでとうございます！</h1>
                    <p>あなたは真実を知る勇気を持った特別な人です</p>
                </div>
                
                <div class="subscription-offer">
                    <h2>永続的な導きを手に入れませんか？</h2>
                    
                    <div class="subscription-benefits">
                        <div class="benefit-item">✅ 毎日の詳細診断</div>
                        <div class="benefit-item">✅ 24時間サポート</div>
                        <div class="benefit-item">✅ 限定コンテンツ</div>
                        <div class="benefit-item">✅ VIPコミュニティ</div>
                    </div>
                    
                    <div class="subscription-pricing">
                        <div class="sub-price">
                            <span class="sub-amount">月額 ¥980</span>
                            <span class="sub-note">（初月無料）</span>
                        </div>
                        <button class="subscribe-button" onclick="PaymentPsychology.processSubscription()">
                            無料で始める
                        </button>
                    </div>
                    
                    <div class="subscription-warning">
                        ⚠️ このオファーは二度と表示されません
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        setTimeout(() => modal.classList.add('show'), 100);
    },

    // タイマー機能
    startTimer(level) {
        const stage = this.stages[level];
        if (!stage.timer) return;

        let remaining = stage.timer;
        const timerElement = document.querySelector(`[data-timer="${stage.timer}"] .timer-display`);
        
        const interval = setInterval(() => {
            const minutes = Math.floor(remaining / 60);
            const seconds = remaining % 60;
            
            if (timerElement) {
                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            remaining--;
            
            if (remaining < 0) {
                clearInterval(interval);
                if (timerElement) {
                    timerElement.textContent = '終了';
                    timerElement.style.color = '#ff6b6b';
                }
            }
        }, 1000);
    },

    // ランダム要素生成（リアリティを演出）
    getRandomDay() {
        const days = ['月曜日', '水曜日', '金曜日', '土曜日', '日曜日'];
        return days[Math.floor(Math.random() * days.length)];
    },

    getRandomAmount() {
        const amounts = [10000, 30000, 50000, 80000, 100000];
        return amounts[Math.floor(Math.random() * amounts.length)].toLocaleString();
    },

    getRandomTalent() {
        const talents = ['リーダーシップ', 'クリエイティビティ', '共感力', '分析力', '直感力'];
        return talents[Math.floor(Math.random() * talents.length)];
    },

    getRandomWarning() {
        const warnings = ['赤い服を着た人', '北東の方角', '偶数の日', '水辺での決断', '急な誘い'];
        return warnings[Math.floor(Math.random() * warnings.length)];
    },

    getRandomDate() {
        const date = new Date();
        date.setDate(date.getDate() + Math.floor(Math.random() * 30) + 1);
        return `${date.getMonth() + 1}月${date.getDate()}日`;
    },

    getRandomMission() {
        const missions = ['人々を導く光となること', '真実を伝える使者', '愛を広める存在', '変革をもたらす者'];
        return missions[Math.floor(Math.random() * missions.length)];
    },

    // オファーを閉じる
    closeOffer() {
        const modal = document.querySelector('.next-offer-modal');
        if (modal) {
            modal.classList.remove('show');
            setTimeout(() => modal.remove(), 300);
        }
    },

    // サブスクリプション処理
    processSubscription() {
        alert('サブスクリプション登録画面へ（Stripe実装）');
        // Stripe定期課金の実装
    }
};

// ページ読み込み時に初期化
document.addEventListener('DOMContentLoaded', () => {
    // 保存されたレベルを復元
    const savedLevel = localStorage.getItem('paymentLevel');
    const savedSpent = localStorage.getItem('totalSpent');
    
    if (savedLevel) {
        PaymentPsychology.currentLevel = parseInt(savedLevel);
    }
    if (savedSpent) {
        PaymentPsychology.totalSpent = parseInt(savedSpent);
    }
});
</script>

<!-- 段階的課金用の追加CSS -->
<style>
/* 価格カード */
.pricing-card {
    background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
    border: 2px solid rgba(255,255,255,0.2);
    border-radius: 20px;
    padding: 30px;
    margin: 20px 0;
    position: relative;
    transition: all 0.3s ease;
}

.pricing-card.current {
    border-color: #ffd700;
    box-shadow: 0 0 30px rgba(255,215,0,0.3);
}

.pricing-card.completed {
    opacity: 0.5;
}

.recommended-badge {
    position: absolute;
    top: -15px;
    right: 20px;
    background: linear-gradient(45deg, #ff6b6b, #ff8e53);
    color: white;
    padding: 8px 20px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 14px;
    animation: pulse 2s infinite;
}

.popular-badge {
    position: absolute;
    top: -15px;
    left: 20px;
    background: linear-gradient(45deg, #f093fb, #f5576c);
    color: white;
    padding: 8px 20px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 14px;
}

.pricing-title {
    font-size: 24px;
    margin-bottom: 10px;
    color: #ffd700;
}

.pricing-description {
    opacity: 0.9;
    margin-bottom: 20px;
}

.pricing-amount {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.original-price {
    text-decoration: line-through;
    opacity: 0.5;
    font-size: 18px;
}

.discount-badge {
    background: #ff6b6b;
    color: white;
    padding: 4px 10px;
    border-radius: 10px;
    font-weight: bold;
    font-size: 14px;
}

.final-price {
    font-size: 48px;
    font-weight: bold;
    color: #ffd700;
    margin: 20px 0;
    display: flex;
    align-items: baseline;
}

.currency {
    font-size: 24px;
    margin-right: 5px;
}

.pricing-bait {
    background: rgba(255,215,0,0.1);
    border-left: 3px solid #ffd700;
    padding: 10px 15px;
    margin: 20px 0;
    font-style: italic;
}

.countdown-timer {
    background: rgba(255,107,107,0.2);
    border: 1px solid #ff6b6b;
    border-radius: 10px;
    padding: 10px;
    margin: 15px 0;
    text-align: center;
}

.timer-label {
    display: block;
    font-size: 12px;
    opacity: 0.8;
    margin-bottom: 5px;
}

.timer-display {
    font-size: 24px;
    font-weight: bold;
    color: #ff6b6b;
}

.purchase-button {
    width: 100%;
    padding: 18px;
    background: linear-gradient(45deg, #ffd700, #ffed4e);
    color: #333;
    border: none;
    border-radius: 50px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 10px 30px rgba(255,215,0,0.3);
}

.purchase-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 15px 40px rgba(255,215,0,0.4);
}

.sunk-cost-reminder {
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    padding: 15px;
    margin-top: 15px;
    text-align: center;
    font-size: 14px;
    color: #ffd700;
}

/* 投資トラッカー */
.investment-tracker {
    background: linear-gradient(135deg, rgba(103,126,234,0.2) 0%, rgba(118,75,162,0.2) 100%);
    border-radius: 15px;
    padding: 20px;
    margin: 30px 0;
    text-align: center;
}

.investment-label {
    font-size: 14px;
    opacity: 0.8;
    margin-bottom: 10px;
}

.investment-amount {
    font-size: 36px;
    font-weight: bold;
    color: #ffd700;
    margin: 10px 0;
}

.investment-progress {
    background: rgba(255,255,255,0.1);
    height: 10px;
    border-radius: 5px;
    overflow: hidden;
    margin: 15px 0;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #ffd700, #ffed4e);
    transition: width 0.5s ease;
}

.investment-message {
    font-style: italic;
    opacity: 0.9;
    margin-top: 10px;
}

/* 処理中オーバーレイ */
.processing-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 100000;
}

.processing-overlay.show {
    opacity: 1;
}

.processing-content {
    text-align: center;
    color: white;
}

.processing-spinner {
    width: 80px;
    height: 80px;
    border: 4px solid rgba(255,255,255,0.2);
    border-top-color: #ffd700;
    border-radius: 50%;
    margin: 0 auto 20px;
    animation: spin 1s linear infinite;
}

.processing-text {
    font-size: 24px;
    margin-bottom: 10px;
}

.processing-subtext {
    font-size: 14px;
    opacity: 0.8;
}

/* 結果表示 */
.revealed-results {
    animation: fadeIn 0.5s ease;
}

.results-title {
    text-align: center;
    font-size: 32px;
    margin: 30px 0;
    color: #ffd700;
}

.results-content {
    background: rgba(255,255,255,0.1);
    border-radius: 15px;
    padding: 25px;
    margin: 20px 0;
}

.result-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    margin: 10px 0;
}

.result-emoji {
    font-size: 32px;
}

.result-text {
    flex: 1;
    line-height: 1.6;
}

.results-teaser {
    background: rgba(255,107,107,0.1);
    border: 2px dashed rgba(255,107,107,0.3);
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
    text-align: center;
}

.locked-content {
    margin-top: 15px;
}

.locked-item {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 10px;
    margin: 5px 0;
    background: rgba(0,0,0,0.2);
    border-radius: 8px;
    opacity: 0.7;
}

.lock-icon {
    font-size: 20px;
}

.locked-text {
    font-style: italic;
}

.all-unlocked {
    font-size: 20px;
    color: #ffd700;
    padding: 20px;
}

/* オファーモーダル */
.next-offer-modal,
.subscription-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 100001;
}

.next-offer-modal.show,
.subscription-modal.show {
    opacity: 1;
}

.offer-modal-content,
.subscription-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 40px;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    color: white;
}

.offer-header,
.subscription-header {
    text-align: center;
    margin-bottom: 30px;
}

.offer-header h2,
.subscription-header h1 {
    font-size: 32px;
    margin-bottom: 10px;
}

.skip-button {
    width: 100%;
    padding: 12px;
    background: transparent;
    border: 1px solid rgba(255,255,255,0.3);
    color: rgba(255,255,255,0.7);
    border-radius: 50px;
    margin-top: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.skip-button:hover {
    background: rgba(255,255,255,0.1);
    color: white;
}

/* サブスクリプション */
.subscription-benefits {
    background: rgba(255,255,255,0.1);
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
}

.benefit-item {
    padding: 10px;
    font-size: 16px;
}

.subscription-pricing {
    text-align: center;
    margin: 30px 0;
}

.sub-price {
    margin-bottom: 20px;
}

.sub-amount {
    font-size: 36px;
    font-weight: bold;
    color: #ffd700;
}

.sub-note {
    display: block;
    font-size: 14px;
    opacity: 0.8;
    margin-top: 5px;
}

.subscribe-button {
    padding: 20px 60px;
    background: linear-gradient(45deg, #ffd700, #ffed4e);
    color: #333;
    border: none;
    border-radius: 50px;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 10px 30px rgba(255,215,0,0.3);
    transition: all 0.3s ease;
}

.subscribe-button:hover {
    transform: scale(1.05);
    box-shadow: 0 15px 40px rgba(255,215,0,0.4);
}

.subscription-warning {
    background: rgba(255,107,107,0.2);
    border: 1px solid #ff6b6b;
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    margin-top: 20px;
}
</style>
